name: Build CEF

on:
  workflow_dispatch:
    inputs:
      runner_mode:
        description: "Runner mode"
        required: true
        type: choice
        default: shared
        options:
          - shared
          - self-hosted
      cef_version:
        description: "CEF version/tag/branch (example: 132.3.0 or 6533)"
        required: true
        type: string
        default: "latest"
  schedule:
    - cron: "0 2 * * 1"

concurrency:
  group: cef-build-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  build:
    name: ${{ matrix.id }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: windows-x64
            shared_runs_on: '["windows-2022"]'
            self_runs_on: '["self-hosted","cef","windows","x64"]'
            build_flag: --x64-build
            extra_env: ""
          - id: linux-x64
            shared_runs_on: '["ubuntu-24.04"]'
            self_runs_on: '["self-hosted","cef","linux","x64"]'
            build_flag: --x64-build
            extra_env: ""
          - id: macos-x64
            shared_runs_on: '["macos-15"]'
            self_runs_on: '["self-hosted","cef","macos","x64"]'
            build_flag: --x64-build
            extra_env: CEF_ENABLE_AMD64=1
          - id: macos-arm64
            shared_runs_on: '["macos-15"]'
            self_runs_on: '["self-hosted","cef","macos","arm64"]'
            build_flag: --arm64-build
            extra_env: ""

    runs-on: ${{ fromJson(((github.event.inputs.runner_mode || 'shared') == 'self-hosted') && matrix.self_runs_on || matrix.shared_runs_on) }}

    env:
      RUNNER_MODE: ${{ github.event.inputs.runner_mode || 'shared' }}
      CEF_VERSION: ${{ github.event.inputs.cef_version || vars.CEF_VERSION || vars.CEF_BRANCH || 'latest' }}
      CEF_GN_DEFINES: ${{ vars.CEF_GN_DEFINES || 'is_official_build=true proprietary_codecs=true ffmpeg_branding=Chrome enable_platform_hevc=true enable_hevc_parser_and_hw_decoder=true' }}
      CEF_FAST_GN_DEFINES: ${{ vars.CEF_FAST_GN_DEFINES || 'symbol_level=0 blink_symbol_level=0 v8_symbol_level=0 use_jumbo_build=true' }}
      SCCACHE_CACHE_SIZE: ${{ vars.SCCACHE_CACHE_SIZE || '80G' }}
      SCCACHE_IDLE_TIMEOUT: "0"
      SCCACHE_DIRECT: "true"
      SCCACHE_IGNORE_SERVER_IO_ERROR: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Resolve paths
        id: paths
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${RUNNER_MODE}" == "self-hosted" ]]; then
            base="${{ vars.CEF_CACHE_ROOT }}"
            if [[ -z "${base}" ]]; then
              base="${HOME}/cef-cache"
            fi
          else
            base="${GITHUB_WORKSPACE}/.cef-cache"
          fi

          download_dir="${base}/${{ matrix.id }}"
          depot_tools_dir="${download_dir}/depot_tools"
          git_cache_dir="${base}/git-cache/${{ matrix.id }}"
          sccache_dir="${base}/sccache/${{ matrix.id }}"
          script_path="${download_dir}/automate-git.py"

          mkdir -p "${download_dir}" "${git_cache_dir}" "${sccache_dir}"

          echo "download_dir=${download_dir}" >> "${GITHUB_OUTPUT}"
          echo "depot_tools_dir=${depot_tools_dir}" >> "${GITHUB_OUTPUT}"
          echo "git_cache_dir=${git_cache_dir}" >> "${GITHUB_OUTPUT}"
          echo "sccache_dir=${sccache_dir}" >> "${GITHUB_OUTPUT}"
          echo "script_path=${script_path}" >> "${GITHUB_OUTPUT}"

          echo "RUNNER_MODE=${RUNNER_MODE}"
          echo "CEF_VERSION=${CEF_VERSION}"
          echo "CEF_GN_DEFINES=${CEF_GN_DEFINES}"
          echo "CEF_FAST_GN_DEFINES=${CEF_FAST_GN_DEFINES}"
          echo "DOWNLOAD_DIR=${download_dir}"
          echo "GIT_CACHE_DIR=${git_cache_dir}"
          echo "SCCACHE_DIR=${sccache_dir}"

      - name: Resolve CEF version to branch/checkout
        id: cef
        shell: bash
        run: |
          set -euo pipefail

          input="${CEF_VERSION}"
          branch=""
          checkout=""

          if [[ "${input}" =~ ^[0-9]{4,}$ ]]; then
            # Backward compatibility: numeric input is treated as branch.
            branch="${input}"
          else
            if [[ "${input}" == "latest" ]]; then
              refs="$(git ls-remote --tags --refs https://github.com/chromiumembedded/cef.git)"
            else
              refs="$(git ls-remote --tags --refs https://github.com/chromiumembedded/cef.git "refs/tags/${input}*")"
            fi

            tag="$(
              printf '%s\n' "${refs}" \
                | awk '{print $2}' \
                | sed 's#refs/tags/##' \
                | sort -V \
                | tail -n 1
            )"

            if [[ -z "${tag}" ]]; then
              echo "Cannot resolve CEF version/tag from input: ${input}" >&2
              exit 1
            fi

            checkout="${tag}"
            chromium_version="$(echo "${tag}" | sed -n 's#.*chromium-\([0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+\).*#\1#p')"

            if [[ -z "${chromium_version}" ]]; then
              compat_url="https://raw.githubusercontent.com/chromiumembedded/cef/${tag}/CHROMIUM_BUILD_COMPATIBILITY.txt"
              chromium_checkout="$(curl -fsSL "${compat_url}" | sed -n \"s/.*'chromium_checkout': '\\([^']\\+\\)'.*/\\1/p\")"
              chromium_version="$(echo "${chromium_checkout}" | sed -n 's#.*\([0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+\).*#\1#p')"
            fi

            branch="$(echo "${chromium_version}" | cut -d. -f3)"
          fi

          if [[ -z "${branch}" ]]; then
            echo "Failed to resolve CEF branch from input: ${input}" >&2
            exit 1
          fi

          echo "branch=${branch}" >> "${GITHUB_OUTPUT}"
          echo "checkout=${checkout}" >> "${GITHUB_OUTPUT}"
          echo "Resolved CEF input '${input}' -> branch=${branch} checkout=${checkout:-<latest-on-branch>}"

      - name: Cache bootstrap and compiler cache (shared runner only)
        if: ${{ env.RUNNER_MODE == 'shared' }}
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.paths.outputs.depot_tools_dir }}
            ${{ steps.paths.outputs.git_cache_dir }}
            ${{ steps.paths.outputs.sccache_dir }}
          key: cef-bootstrap-${{ matrix.id }}-${{ steps.cef.outputs.branch }}-${{ hashFiles('.github/workflows/cef-build.yml') }}
          restore-keys: |
            cef-bootstrap-${{ matrix.id }}-${{ steps.cef.outputs.branch }}-
            cef-bootstrap-${{ matrix.id }}-

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure sccache backend
        shell: bash
        run: |
          set -euo pipefail
          echo "SCCACHE_DIR=${{ steps.paths.outputs.sccache_dir }}" >> "${GITHUB_ENV}"
          echo "SCCACHE_CACHE_SIZE=${SCCACHE_CACHE_SIZE}" >> "${GITHUB_ENV}"
          if [[ "${RUNNER_MODE}" == "shared" ]]; then
            echo "SCCACHE_GHA_ENABLED=true" >> "${GITHUB_ENV}"
          else
            echo "SCCACHE_GHA_ENABLED=false" >> "${GITHUB_ENV}"
          fi

      - name: Warm up sccache
        shell: bash
        run: |
          set -euo pipefail
          "${SCCACHE_PATH:-sccache}" --start-server || true
          "${SCCACHE_PATH:-sccache}" --zero-stats || true

      - name: Fetch automate-git.py
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL \
            https://raw.githubusercontent.com/chromiumembedded/cef/master/tools/automate/automate-git.py \
            -o "${{ steps.paths.outputs.script_path }}"

      - name: Build CEF
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${{ matrix.extra_env }}" ]]; then
            export ${{ matrix.extra_env }}
          fi

          export GIT_CACHE_PATH="${{ steps.paths.outputs.git_cache_dir }}"
          export GN_DEFINES="${CEF_GN_DEFINES} ${CEF_FAST_GN_DEFINES} cc_wrapper=\"sccache\""

          checkout_args=()
          if [[ -n "${{ steps.cef.outputs.checkout }}" ]]; then
            checkout_args+=(--checkout="${{ steps.cef.outputs.checkout }}")
          fi

          python "${{ steps.paths.outputs.script_path }}" \
            --download-dir="${{ steps.paths.outputs.download_dir }}" \
            --depot-tools-dir="${{ steps.paths.outputs.download_dir }}/depot_tools" \
            --branch="${{ steps.cef.outputs.branch }}" \
            "${checkout_args[@]}" \
            --minimal-distrib \
            --client-distrib \
            --no-chromium-history \
            --no-debug-build \
            ${{ matrix.build_flag }}

      - name: Show sccache stats
        if: ${{ always() }}
        shell: bash
        run: |
          set +e
          "${SCCACHE_PATH:-sccache}" --show-stats
          "${SCCACHE_PATH:-sccache}" --stop-server

      - name: Upload binary distrib
        uses: actions/upload-artifact@v4
        with:
          name: cef-${{ matrix.id }}-branch-${{ steps.cef.outputs.branch }}-${{ steps.cef.outputs.checkout != '' && 'pinned' || 'head' }}
          path: ${{ steps.paths.outputs.download_dir }}/chromium/src/cef/binary_distrib/
          if-no-files-found: error
          retention-days: 7
