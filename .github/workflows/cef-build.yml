name: Build CEF

on:
  workflow_dispatch:
    inputs:
      runner_mode:
        description: "Runner mode"
        required: true
        type: choice
        default: shared
        options:
          - shared
          - self-hosted
      cef_branch:
        description: "CEF branch number (example: 6533)"
        required: true
        type: string
        default: "6533"
  schedule:
    - cron: "0 2 * * 1"

concurrency:
  group: cef-build-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  build:
    name: ${{ matrix.id }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: windows-x64
            shared_runs_on: '["windows-2022"]'
            self_runs_on: '["self-hosted","cef","windows","x64"]'
            build_flag: --x64-build
            extra_env: ""
          - id: linux-x64
            shared_runs_on: '["ubuntu-24.04"]'
            self_runs_on: '["self-hosted","cef","linux","x64"]'
            build_flag: --x64-build
            extra_env: ""
          - id: macos-x64
            shared_runs_on: '["macos-15"]'
            self_runs_on: '["self-hosted","cef","macos","x64"]'
            build_flag: --x64-build
            extra_env: CEF_ENABLE_AMD64=1
          - id: macos-arm64
            shared_runs_on: '["macos-15"]'
            self_runs_on: '["self-hosted","cef","macos","arm64"]'
            build_flag: --arm64-build
            extra_env: ""

    runs-on: ${{ fromJson(((github.event.inputs.runner_mode || 'shared') == 'self-hosted') && matrix.self_runs_on || matrix.shared_runs_on) }}

    env:
      RUNNER_MODE: ${{ github.event.inputs.runner_mode || 'shared' }}
      CEF_BRANCH: ${{ github.event.inputs.cef_branch || vars.CEF_BRANCH || '6533' }}
      CEF_GN_DEFINES: ${{ vars.CEF_GN_DEFINES || 'is_official_build=true proprietary_codecs=true ffmpeg_branding=Chrome enable_platform_hevc=true enable_hevc_parser_and_hw_decoder=true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Resolve paths
        id: paths
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${RUNNER_MODE}" == "self-hosted" ]]; then
            base="${{ vars.CEF_CACHE_ROOT }}"
            if [[ -z "${base}" ]]; then
              base="${HOME}/cef-cache"
            fi
          else
            base="${GITHUB_WORKSPACE}/.cef-cache"
          fi

          download_dir="${base}/${{ matrix.id }}"
          script_path="${download_dir}/automate-git.py"

          mkdir -p "${download_dir}"

          echo "download_dir=${download_dir}" >> "${GITHUB_OUTPUT}"
          echo "script_path=${script_path}" >> "${GITHUB_OUTPUT}"

          echo "RUNNER_MODE=${RUNNER_MODE}"
          echo "CEF_BRANCH=${CEF_BRANCH}"
          echo "CEF_GN_DEFINES=${CEF_GN_DEFINES}"
          echo "DOWNLOAD_DIR=${download_dir}"

      - name: Cache CEF workspace (shared runner only)
        if: ${{ env.RUNNER_MODE == 'shared' }}
        uses: actions/cache@v4
        with:
          path: ${{ steps.paths.outputs.download_dir }}
          key: cef-${{ matrix.id }}-${{ env.CEF_BRANCH }}-${{ github.run_id }}
          restore-keys: |
            cef-${{ matrix.id }}-${{ env.CEF_BRANCH }}-

      - name: Fetch automate-git.py
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL \
            https://raw.githubusercontent.com/chromiumembedded/cef/master/tools/automate/automate-git.py \
            -o "${{ steps.paths.outputs.script_path }}"

      - name: Build CEF
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${{ matrix.extra_env }}" ]]; then
            export ${{ matrix.extra_env }}
          fi

          export GN_DEFINES="${CEF_GN_DEFINES}"

          python "${{ steps.paths.outputs.script_path }}" \
            --download-dir="${{ steps.paths.outputs.download_dir }}" \
            --depot-tools-dir="${{ steps.paths.outputs.download_dir }}/depot_tools" \
            --branch="${CEF_BRANCH}" \
            --minimal-distrib \
            --client-distrib \
            --no-chromium-history \
            --no-debug-build \
            ${{ matrix.build_flag }}

      - name: Upload binary distrib
        uses: actions/upload-artifact@v4
        with:
          name: cef-${{ matrix.id }}-branch-${{ env.CEF_BRANCH }}
          path: ${{ steps.paths.outputs.download_dir }}/chromium/src/cef/binary_distrib/
          if-no-files-found: error
          retention-days: 7
